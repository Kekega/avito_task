# Тестовое задание на позицию стажёра-бэкендера
В этом репозитории находится реализация [тестового задания](https://github.com/avito-tech/internship_backend_2022)
на позицию стажёра-бэкендера в Avito.

## Запуск
Необходимо скачать исходный код проекта и перейти в скачанную папку.
```
git clone https://github.com/Kekega/avito_task.git

cd avito_task
```
Для запуска API сервера используется следующая команда:
```
docker-compose up
```

По умолчанию сервер доступен по адресу http://localhost:8080/.

## Описание API

Детальное описание каждого endpoint'а с примерами открывается по клику:

- [Получить баланс пользователя](https://github.com/alien-agent/users-balance-microservice/blob/master/docs/balance.md)
  :`POST /v1/deposits/balance`
- [Изменить баланс пользователя](https://github.com/alien-agent/users-balance-microservice/blob/master/docs/update.md)
  :`POST /v1/deposits/update`
- [Перевести деньги между двумя пользователями](https://github.com/alien-agent/users-balance-microservice/blob/master/docs/transfer.md)
  :`POST /v1/deposits/transfer`
- [Получить историю операций пользователя](https://github.com/alien-agent/users-balance-microservice/blob/master/docs/history.md)
  :`POST /v1/deposits/history`

Коллекция запросов для запуска в Postman находится в файле [postman_examples.json]().

## Детали реализации

Микросервис написан на Go, СУБД - PostgreSQL. Все запросы/ответы принимаются/отдаются в формате JSON.

#### Как обеспечивается устойчивость данных о балансе пользователя?
1. На уровне *SQL Schema* установлен запрет на сохранение отрицательных балансов - даже в случае наличия бага в коде метод
   получит ошибку базы данных и сообщит о ней внешнему сервису.
2. Методы API, подразумевающие неоднократную запись в базу данных, вносят все изменения в БД в одной транзакции. В
   случае если в процессе работы происходит ошибка, все изменения откатываются и API сообщает внешнему сервису об ошибке. Например,
   при переводе денег между пользователями со счета отправителя сняли нужную сумму, но при начислении ее получателю произошла ошибка:
   `TransactionHandler` гарантирует, что произойдет откат баланса отправителя, после чего API вернет ошибку.
3. Для представления баланса пользователя в API и БД используются 64-битные числа, что достаточно для представления любой
   практической суммы денег.

#### Конфигурация
Некоторые параметры сервиса можно настраивать с помощью файлов конфигурации:
- `server_port` - порт, на котором API сервер будет принимать запросы
- `dsn` - строка с настройками подключения к БД PostgreSQL

По умолчанию используется файл конфигурации `dev.yml`, а при запуске внутри Docker - `local.yml`. Также возможна
конфигурация с помощью переменных среды - их приоритет выше, чем у файлов конфигурации. Соответствующие переменные среды
должны иметь префикс `APP_`, например: `APP_DSN`.

#### Доп. задание №2
История изменений баланса пользователя представлена набором транзакций. 

## Вопросы по ТЗ и их решения

### Тип баланса пользователей
Изучив оъявления сторонних продавцов на Авито, я решил, 
что позволительно использовать тип Int для баланса пользователей, так как стоимость объявлений составляла целое чило рублей.

### Баланс для несуществующих пользователей
Я решил, что будет предпочтительнее показывать пользователю нулевой баланс до первого пополнения счета вместо сообщения об ошибке.
Поэтому (при условии прохождения валидации запроса) сервер сообщает о нулевом балансе если нужный счет не найден в БД.

### Способ резервирования средств на счете
Для простоты реализации моего проекта, я решил, что будет допустимо организовать заморозку средств на счете в виде `pending` запроса.
В случае заморозки средств создается запрос с параметром `pending = true`, после признания выручки его значение меняется на `false`.
Если необходимо отменить резервирование средств, то на счет пользователя зачисляется сумма запроса, а сам запрос удаляется из таблицы зпросов.

## Структура проекта

```
.
├───cmd
│   └───server
├───config
├───internal
│   ├───config
│   ├───deposit
│   ├───entity
│   ├───errors
│   ├───requests
│   ├───respository
│   └───transaction
└───pkg
    ├───accesslog
    ├───dbcontext
    └───log

```

Проект основан на [Go RESTful API Starter Kit](https://github.com/qiangxue/go-rest-api).